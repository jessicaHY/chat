define(["kernel","react"],function(t){var e=$(window),i=$(document),n=t.Class.extend({init:function(e,i,s){var h;return"string"==typeof e&&((h=n.template[e])?(e=$(h.element),i=$.extend({},h.options,i)):e=$(e),t.body.append(e)),e.attr("id")&&!document.getElementById(e.attr("id"))&&t.body.append(e),this._reactElement=e.data("reactElement"),"undefined"!=typeof s&&$.extend(this,s),e.data("flyout")?e.data("flyout"):(e.data("flyout",this),this._baseFlyoutConstructor(e,i),this.primaryId=n.primaryId++,void(n.cache[this.primaryId]=this))},_element:null,_anchor:null,_where:{},_event_hide_id:null,_isHide:!0,_currentAnchor:null,_currentAnchorBox:{},_reactElement:null,parasitic:{},getRef:function(t){return"undefined"==typeof t?this._reactElement.refs:t in this?this[t]:t in this._reactElement.refs?this._reactElement.refs[t]:null},getReact:function(){return this._reactElement},_baseFlyoutConstructor:function(t,e,i){this.setting=$.extend({onRendered:$.noop,onShow:$.noop,onHide:$.noop,destroy:!1,alone:!1,sameAnchorHide:!0,hideDirect:"default",stayTime:0,anchorStay:!1,hideOffset:10,showOffset:10,showDuration:150,easing:"swing",classStyle:"",alignment:"center",placement:"top",arrow:!0,stop:!1},e),$.isPlainObject(i)&&$.extend(this,i),this.element=t,this.alone=this.setting.alone,this._originalHTML=t.html(),this.element.addClass("ui-flyout").css({position:"absolute"}),this.setting.stop&&this.element.click(function(t){t.stopPropagation()}),this.setting.anchor&&(this._anchor=e.anchor),this.element.addClass(this.setting.classStyle),this._placement=this.setting.placement,this._alignment=this.setting.alignment,this.setting.onRendered.call(this,t),this.setting.arrow&&(this._arrow=$('<span class="flyout-arrow"></span>'),this.element.append(this._arrow))},arrow:function(){"use strict";this._arrow=$('<span class="flyout-arrow"></span>'),this.element.append(this._arrow)},show:function(t,e,i){this._baseFlyoutShow(t,e,i)},hide:function(){this._documentBind(!0),this._baseFlyoutHide()},lastAnchor:function(){return this._currentAnchor},_createStayTimer:function(){var t=this;this.setting.stayTime&&(this._clearStay(),this._stayTimer=setTimeout(function(){t.hide()},this.setting.stayTime+this.setting.showDuration))},_clearStay:function(){this._stayTimer&&(clearTimeout(this._stayTimer),this._stayTimer=null)},_documentName:"",_documentBind:function(e){var n=this;e&&""!=this._documentName?(i.unbind(this._documentName),n._documentName=""):""==this._documentName&&(this._documentName=t.clickAnyWhereHideButMe(this.element,function(){n.hide()}))},destroy:function(){var t=this.primaryId;this.element.remove(),n.cache[t]=null,delete n.cache[t]},recover:function(){this.element.html(this._originalHTML)},_arrowPostion:function(t){var t=this.element.find("span.flyout-arrow").attr("class","flyout-arrow"),e="";switch(this._where.at){case"top":e="bottom";break;case"bottom":e="top";break;case"left":e="right";break;case"right":e="left"}var i=15;this._currentAnchorBox.width>15&&(i=0),"right"==this._currentAlignment?this._startPosition.left+=i:"left"==this._currentAlignment&&(this._startPosition.left-=i),t.addClass(e+" "+e+"-"+this._currentAlignment)},_baseFlyoutShow:function(t,e,i){var s=this,h=this.element,o=!1;return t?t.jquery||(t=$(t)):t=this._anchor,e||(e=this._placement),i||(i=this._alignment),t?(this._currentAnchor&&this._currentAnchor[0]==t[0]&&(o=!0),this._currentAnchor=t,this._currentPlacement=e,this._currentAlignment=i,n.currentShowFlyout=this,t&&this._getTopLeft(),this.alone||this._hideAllVisibleFlyout(),void(o&&this.setting.sameAnchorHide&&!this._isHide?this.hide():(!o||o&&!this.setting.sameAnchorHide||o&&this.setting.sameAnchorHide&&this._isHide)&&(this._documentBind(!0),this._createStayTimer(),this.setting.arrow&&s._arrowPostion(),h.show().css("z-index",this._getZIndex(t)).css(this._startPosition).stop().animate(this._endPosition,{easing:this.setting.easing,duration:this.setting.showDuration,complete:function(){s._isHide=!1,s._documentBind()}}),s.setting.onShow.call(s,h,t)))):void console.error("没有标记触发手柄")},_baseFlyoutHide:function(){this._clearStay();var t=this,e={opacity:0},i=this.setting.hideOffset;switch(this._where.at){case"bottom":e.top=this.element.offset().top+i;break;case"top":e.top=this.element.offset().top-i;break;case"left":e.left=this.element.offset().left-i;break;case"right":e.left=this.element.offset().left+i}this.element.stop().animate(e,{easing:this.setting.easing,duration:160,complete:function(){$(this).hide(),t._isHide=!0,t.setting.destroy&&t.destroy()}}),this.setting.onHide.call(this,this.element,this._currentAnchor)},_hideAllVisibleFlyout:function(){var t=this.primaryId;$.each(n.cache,function(e,i){!i||t==e||i._isHide||i.alone||i.hide()})},_getZIndex:function(t){var e=1e3,i=t.parentsUntil("body").last().css("z-index");return"auto"!=i&&i>=e&&(e=i+1),e},_getTopLeft:function(){var t=this._currentAnchor,i=this._currentAnchorBox={left:t.offset().left,right:t.offset().left+t.outerWidth(),top:t.offset().top,bottom:t.offset().top+t.outerHeight(),width:t.outerWidth(),height:t.outerHeight()},n={width:this.element.outerWidth(),height:this.element.outerHeight()};switch(this._currentScrollTop=e.scrollTop(),this._startPosition={opacity:0},this._endPosition={opacity:1},this._currentPlacement){case"top":this._where.at="top",this._fitTop(i,n)||(this._fitBottom(i,n),this._where.at="bottom"),this._alignHorizontally(i,n);break;case"bottom":this._where.at="bottom",this._fitBottom(i,n)||(this._fitTop(i,n),this._where.at="top"),this._alignHorizontally(i,n);break;case"left":this._where.at="left",this._fitLeft(i,n)||(this._fitRight(i,n),this._where.at="right"),this._alignVertically(i,n);break;case"right":this._where.at="right",this._fitRight(i,n)||(this._fitLeft(i,n),this._where.at="left"),this._alignVertically(i,n);break;case"auto":}switch(this._currentAlignment){case"top":break;case"bottom":break;case"left":break;case"right":}},_fitTop:function(t,e){return this._nextTop=t.top-e.height,this._nextAnimTop=this._nextTop-this.setting.showOffset,this._nextTop>=0&&this._nextAnimTop>this._currentScrollTop&&this._nextAnimTop+e.height<t.top},_fitBottom:function(t,i){return this._nextTop=t.bottom,this._nextAnimTop=t.bottom+this.setting.showOffset,this._nextTop>=0&&this._nextAnimTop-this._currentScrollTop+i.height<e.height()},_fitLeft:function(t,i){return this._nextLeft=t.left-i.width+this.setting.showOffset,this._nextAnimLeft=this._nextLeft-2*this.setting.showOffset,this._nextLeft>=0&&this._nextLeft+i.width<e.width()},_fitRight:function(t,i){return this._nextLeft=t.right-this.setting.showOffset,this._nextAnimLeft=this._nextLeft+2*this.setting.showOffset,this._nextLeft>=0&&this._nextLeft+i.width<e.width()},_fitAlignLeft:function(t,i){return this._nextLeft=t.left,t.left+i.width<e.width()},_fitAlignRight:function(t,e){return this._nextLeft=t.right-e.width,t.right>e.width},_alignVertically:function(t,e){"center"==this._currentAlignment?this._nextTop=t.top+t.height/2-e.height/2:"top"==this._currentAlignment?this._nextTop=t.top:"bottom"==this._currentAlignment&&(this._nextTop=t.bottom-e.height),this._startPosition.top=this._nextTop,this._startPosition.left=this._nextLeft,this._endPosition.left=this._nextAnimLeft},_alignHorizontally:function(t,i){var n=e.width();"center"==this._currentAlignment&&(this._nextLeft=t.left+t.width/2-i.width/2,this._nextLeft+i.width>n?this._currentAlignment="right":this._nextLeft<0&&(this._currentAlignment="left")),"left"!=this._currentAlignment||this._fitAlignLeft(t,i)?"right"!=this._currentAlignment||this._fitAlignRight(t,i)||(this._fitAlignLeft(t,i),this._currentAlignment="left"):(this._fitAlignRight(t,i),this._currentAlignment="right"),this._startPosition.left=this._nextLeft,this._startPosition.top=this._nextTop,this._endPosition.top=this._nextAnimTop}},{primaryId:0,cache:{},currentShowFlyout:null,hideAllFlyout:function(){$(".ui-flyout:visible").each(function(){var t=$(this),e=t.data("flyout");e&&t.is(":visible")&&e.hide()})},template:{base:{element:'<div class="ui-flyout box"><div class="mod"><div class="bd"></div><div class="ft"></div></div></div>'}}});return n});